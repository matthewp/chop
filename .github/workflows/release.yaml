name: Release (FreeBSD/macOS)

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build
        run: make

      - name: Wait for Codeberg release
        run: sleep 30

      - name: Upload to Codeberg release
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          TAG=${GITHUB_REF_NAME}

          # Get release ID
          RELEASE_ID=$(curl -s \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/tags/${TAG}" \
            | jq -r '.id')

          # Upload binary
          curl --fail \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            -X POST \
            --upload-file chop \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/${RELEASE_ID}/assets?name=chop-macos-arm64"

      - name: Update Homebrew formula
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          SHA256=$(sha256sum chop | awk '{print $1}')

          git clone https://x-access-token:${GH_TOKEN}@github.com/matthewp/homebrew-chop.git
          cd homebrew-chop

          cat > Formula/chop.rb << EOF
          class Chop < Formula
            desc "Unix-philosophy CLI todo manager"
            homepage "https://codeberg.org/mphillips/chop"
            url "https://codeberg.org/mphillips/chop/releases/download/v${VERSION}/chop-macos-arm64"
            sha256 "${SHA256}"
            version "${VERSION}"
            license "BSD-3-Clause"

            def install
              bin.install "chop-macos-arm64" => "chop"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/chop --version")
            end
          end
          EOF

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Formula/chop.rb
          git commit -m "Update chop to v${VERSION}"
          git push

  build-freebsd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build in FreeBSD
        uses: vmactions/freebsd-vm@v1
        with:
          release: "14.2"
          usesh: true
          run: |
            make
            mkdir -p release
            cp chop release/chop-freebsd-amd64

            # Build package
            VERSION=${GITHUB_REF_NAME#v}
            export VERSION
            ./freebsd-package/build-package.sh

      - name: Upload to Codeberg release
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          TAG=${GITHUB_REF_NAME}

          # Get release ID
          RELEASE_ID=$(curl -s \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/tags/${TAG}" \
            | jq -r '.id')

          # Upload binary
          curl --fail \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            -X POST \
            --upload-file release/chop-freebsd-amd64 \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/${RELEASE_ID}/assets?name=chop-freebsd-amd64"

      - name: Upload FreeBSD repo artifact
        uses: actions/upload-artifact@v4
        with:
          name: freebsd-repo
          path: repo/

  publish-pages:
    needs: build-freebsd
    runs-on: ubuntu-latest
    steps:
      - name: Download FreeBSD repo
        uses: actions/download-artifact@v4
        with:
          name: freebsd-repo
          path: gh-pages/freebsd

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages
