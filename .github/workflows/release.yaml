name: Release (FreeBSD/macOS)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.5.12)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
          fetch-depth: 0

      - name: Install scdoc
        run: brew install scdoc

      - name: Build
        run: make VERSION=${{ inputs.version }}

      - name: Upload to Codeberg release
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          TAG=${{ inputs.version }}

          # Get release ID
          RELEASE_ID=$(curl -s \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/tags/${TAG}" \
            | jq -r '.id')

          # Upload binary
          curl --fail \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            -X POST \
            --upload-file chop \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/${RELEASE_ID}/assets?name=chop-macos-arm64"

      - name: Get binary checksum
        id: checksum
        run: echo "sha256=$(shasum -a 256 chop | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: matthewp/homebrew-chop
          token: ${{ secrets.HOMEBREW_TOKEN }}
          path: homebrew-chop

      - name: Update Homebrew formula
        run: |
          VERSION=${{ inputs.version }}
          VERSION=${VERSION#v}
          SHA256=${{ steps.checksum.outputs.sha256 }}

          cat > homebrew-chop/Formula/chop.rb << EOF
          class Chop < Formula
            desc "Unix-philosophy CLI todo manager"
            homepage "https://codeberg.org/mphillips/chop"
            url "https://codeberg.org/mphillips/chop/releases/download/v${VERSION}/chop-macos-arm64"
            sha256 "${SHA256}"
            version "${VERSION}"
            license "BSD-3-Clause"

            def install
              bin.install "chop-macos-arm64" => "chop"
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/chop --version")
            end
          end
          EOF

          cd homebrew-chop
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add Formula/chop.rb
          git commit -m "Update chop to v${VERSION}"
          git push

  build-freebsd:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
          fetch-depth: 0

      - name: Build in FreeBSD
        uses: vmactions/freebsd-vm@v1
        env:
          VERSION_TAG: ${{ inputs.version }}
        with:
          release: "14.2"
          usesh: true
          envs: 'VERSION_TAG'
          prepare: |
            pkg install -y scdoc
          run: |
            make VERSION=${VERSION_TAG}
            mkdir -p release
            cp chop release/chop-freebsd-amd64

            # Build package
            VERSION=${VERSION_TAG#v}
            export VERSION
            ./freebsd-package/build-package.sh

      - name: Upload to Codeberg release
        env:
          CODEBERG_TOKEN: ${{ secrets.CODEBERG_TOKEN }}
        run: |
          TAG=${{ inputs.version }}

          # Get release ID
          RELEASE_ID=$(curl -s \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/tags/${TAG}" \
            | jq -r '.id')

          # Upload binary
          curl --fail \
            -H "Authorization: token ${CODEBERG_TOKEN}" \
            -X POST \
            --upload-file release/chop-freebsd-amd64 \
            "https://codeberg.org/api/v1/repos/mphillips/chop/releases/${RELEASE_ID}/assets?name=chop-freebsd-amd64"

      - name: Upload FreeBSD repo artifact
        uses: actions/upload-artifact@v4
        with:
          name: freebsd-repo
          path: repo/

  publish-pages:
    needs: build-freebsd
    runs-on: ubuntu-latest
    steps:
      - name: Download FreeBSD repo
        uses: actions/download-artifact@v4
        with:
          name: freebsd-repo
          path: gh-pages/freebsd

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gh-pages

  update-aur:
    runs-on: ubuntu-latest
    steps:
      - name: Update AUR package
        env:
          AUR_SSH_KEY: ${{ secrets.AUR_SSH_KEY }}
          VERSION: ${{ inputs.version }}
        run: |
          VERSION=${VERSION#v}

          # Setup SSH for AUR
          mkdir -p ~/.ssh
          echo "$AUR_SSH_KEY" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          cat >> ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
          EOF
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts 2>/dev/null

          # Clone AUR repo
          git clone ssh://aur@aur.archlinux.org/chop.git aur-chop
          cd aur-chop

          # Get source tarball checksum
          SHA256=$(curl -sL "https://codeberg.org/mphillips/chop/archive/v${VERSION}.tar.gz" | sha256sum | awk '{print $1}')

          # Update PKGBUILD
          sed -i "s/^pkgver=.*/pkgver=${VERSION}/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          sed -i "s/^sha256sums=.*/sha256sums=('${SHA256}')/" PKGBUILD

          # Regenerate .SRCINFO using Arch container
          docker run --rm -v "$PWD":/pkg -w /pkg archlinux:latest bash -c \
            "pacman -Sy --noconfirm base-devel && chown -R nobody:nobody /pkg && sudo -u nobody makepkg --printsrcinfo > .SRCINFO"

          # Commit and push
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add PKGBUILD .SRCINFO
          git diff --cached --quiet || git commit -m "Update to ${VERSION}"
          git push
